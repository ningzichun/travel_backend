# 接口文档
[toc]



## django后端接口

### 用户认证

#### 验证码

接口地址：/user/captcha

请求方式：GET

说明：用户提交注册登录以及重置密码前，需要获取验证码。验证码只能使用一次，刷新验证码即重新获取

返回内容：image/png，cookie

#### 登录
接口地址：/user/login

请求方式：POST

请求参数：

| 名称                                    | 类型   | 必填 | 说明                   |
| --------------------------------------- | ------ | ---- | ---------------------- |
| (user)或(uid,uname,phone,email)其中一项 | string | 是   | 传入user则自动判断类型 |
| password                                | string | 是   | 用户密码               |
| captcha                                 | string | 是   | 验证码                 |
| no_captcha                              | bool   | 否   | debug中跳过验证码      |

返回参数：

| HTTP状态码 | 返回json中，msg的值                                          | 说明                                |
| ---------- | ------------------------------------------------------------ | ----------------------------------- |
| 200        | 登录成功                                                     | 在cookie中返回session，存储登录信息 |
| 403        | 请使用 POST 请求\|无效参数\|无此用户\|密码错误\|请输入验证码\|验证码过期\|验证码错误 |                                     |
| 500        | 服务器错误                                                   | 下同                                |

登录成功时，返回json信息

| 名称        | 说明                              |
| ----------- | --------------------------------- |
| uid         | 用户ID                            |
| uname       | 用户名                            |
| phone | 手机号 |
| email | 邮箱 |
| gender | 0未设置 1男 2女 |
| intro | 个人介绍 |
| avatar      | 用户头像文件相对于根目录的地址，或完整url |



#### 登出
接口地址：/user/logout

请求方式：GET / POST

请求参数：无，从session中获取用户信息


返回参数：

| HTTP状态码 | 返回json中，msg的值 | 说明                                |
| ---------- | ------------------- | ----------------------------------- |
| 200        | 已清除登录信息      | 服务器已清除session中存储的登录信息 |



#### 注册

接口地址：/user/register

请求方式：POST

请求参数：

| 名称         | 类型   | 必填 | 说明                             |
| ------------ | ------ | ---- | -------------------------------- |
| uname        | string | 是   | 用户名                           |
| phone或email | string | 是   | 手机或邮箱至少一项               |
| password     | string | 是   | 用户密码，密码在后端也会加密一次 |
| no_captcha   | bool   | 否   | debug中跳过验证码                |

返回参数：

| HTTP状态码 | 返回json中，msg的值                                          | 说明              |
| ---------- | ------------------------------------------------------------ | ----------------- |
| 200        | 注册成功                                                     |                   |
| 403        | 无效参数：缺少用户名或密码\|无效参数：缺少手机或邮箱\|用户ID已存在\|用户名已存在\|注册错误\|请输入验证码\|验证码错误\|用户名不能全为数字\|手机号格式不正确\|用户名包含特殊字符 | uname不能为纯数字 |



#### 修改密码

接口地址：/user/password

请求方式：POST

请求参数：

| 名称         | 类型   | 必填 | 说明   |
| ------------ | ------ | ---- | ------ |
| old_password | string | 是   | 旧密码 |
| new_password | string | 是   | 新密码 |

返回参数：

| HTTP状态码 | 返回json中，msg的值                                          | 说明 |
| ---------- | ------------------------------------------------------------ | ---- |
| 200        | 成功地修改了密码                                             |      |
| 403        | 请使用 POST 请求\|无效参数\|未登录或登录超时\|无此用户\|旧密码错误 |      |




#### 上传头像

接口地址：/user/avatar

请求方式：POST

请求参数：

| 名称   | 类型 | 必填 | 说明             |
| ------ | ---- | ---- | ---------------- |
| avatar | file | 是   | 用户要求的新头像 |

返回参数：

| HTTP状态码 | 返回json中，msg的值              | 说明                                    |
| ---------- | -------------------------------- | --------------------------------------- |
| 200        | 成功地修改了头像                 | 访问链接：/media/avatars/$uid.$图片格式 |
| 403        | 未登录或登录超时\|未获取到avatar |                                         |



#### 用户信息

接口地址：/user/info

请求方式：GET，查询用户信息

请求方式：POST，修改用户信息

请求参数：

| 名称   | 类型 | 必填 | 说明             |
| ------ | ---- | ---- | ---------------- |
| gender | string | 否   | 要修改的性别     |
| phone | string | 否   | 要修改的手机号   |
| email | string | 否   | 要修改的邮箱     |
| intro | string | 否   | 要修改的个人介绍 |

返回参数：
| 名称        | 说明                              |
| ----------- | --------------------------------- |
| uid         | 用户ID                            |
| uname       | 用户名                            |
| phone | 手机号 |
| email | 邮箱 |
| gender | 0未设置 1男 2女 |
| intro | 个人介绍 |
| avatar      | 用户头像文件相对于根目录的地址，或完整url |



#### 忘记密码

接口地址：/user/reset

请求方式：POST

第一次请求：

| 名称         | 类型   | 必填 | 说明              |
| ------------ | ------ | ---- | ----------------- |
| email或phone | string | 是   | 恢复凭证          |
| captcha      | string | 是   | 验证码            |
| no_captcha   | bool   | 否   | debug中跳过验证码 |

返回参数：

| HTTP状态码 | 返回json中，msg的值                                | 说明                                                    |
| ---------- | -------------------------------------------------- | ------------------------------------------------------- |
| 200        | 已发送恢复码至邮箱\|已发送恢复码至手机             |                                                         |
| 403        | 验证码错误\|找不到用户\|发送邮件失败\|发送短信失败 | 输入错误会使CAPTCHA失效；发送邮件失败时，返回错误类型。 |

```
{"code":403,"data":"发送邮件失败：SMTPRecipientsRefused({'example@example.example': (550, b'Mailbox not found or access denied')})"}
```

第二次及以后的请求：

| 名称         | 类型   | 必填 | 说明                     |
| ------------ | ------ | ---- | ------------------------ |
| code         | string | 是   | 向密保方式中发送的恢复码 |
| captcha      | string | 是   | 验证码                   |
| new_password | string | 是   | 新密码                   |

返回参数：

| HTTP状态码 | 返回json中，msg的值                                    | 说明                    |
| ---------- | ------------------------------------------------------ | ----------------------- |
| 200        | 修改成功                                               |                         |
| 403        | 验证码错误\|未获取恢复码或已失效\|恢复码错误\|参数错误 | 输入错误会使CAPTCHA失效 |



### 社区

#### 获取帖子概要

接口地址：/forum/

请求方式：GET

返回JSON说明：

| 名称      | 说明                                                         |
| --------- | ------------------------------------------------------------ |
| post_num  | 总文章数，每10条文章算一页，可以计算总页数。这里返回最新10条帖子的概要 |
| new_posts | 文章列表，格式如下表所示                                     |

| 名称     | 说明                         |
| -------- | ---------------------------- |
| post_id  | 文章ID                       |
| uid      | 用户ID                       |
| uname    | 用户名                       |
| avatar   |                              |
| title    | 文章标题                     |
| type     | 文章类型                     |
| text     | 文章内容，这里截取前50个字符 |
| time     | 发表时间                     |
| like_num | 赞数                         |

#### 获取一页帖子

接口地址：/forum/page/$page_num

请求方式：GET

请求参数：

| 名称     | 类型 | 必填 | 说明                                        |
| -------- | ---- | ---- | ------------------------------------------- |
| page_num | int  | 是   | 从1开始计算的页数，每页10篇文章，按时间降序 |

返回JSON说明：

| 名称     | 说明                               |
| -------- | ---------------------------------- |
| post_id  | 文章ID                             |
| uid      | 用户ID                             |
| uname    | 用户名                             |
| gender   | 性别                               |
| avatar   | 用户头像文件相对于站点根目录的地址 |
| title    | 文章标题                           |
| type     | 文章类型                           |
| text     | 文章内容，这里截取前50个字符       |
| time     | 发表时间                           |
| like_num | 赞数                               |



#### 获取某个帖子

接口地址：/forum/post/$pid

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明   |
| ---- | ---- | ---- | ------ |
| pid  | int  | 是   | 帖子ID |

返回JSON说明：


| 名称        | 说明                              |
| ----------- | --------------------------------- |
| post_id     | 文章ID                            |
| uid         | 用户ID                            |
| uname       | 用户名                            |
| gender      | 性别                              |
| avatar      | 用户头像文件相对于站点根目录的地址 |
| title       | 文章标题                          |
| type     | 文章类型                          |
| text        | 文章内容                          |
| time        | 发表时间                          |
| like_num    | 赞数                              |
| comment_num | 评论总数                          |
| comments    | 评论列表，格式如下表所示          |

| 名称       | 说明                               |
| ---------- | ---------------------------------- |
| comment_id | 评论ID                             |
| uid        | 用户ID                             |
| uname      | 用户名                             |
| gender     | 性别                               |
| avatar     | 用户头像文件相对于站点根目录的地址 |
| text       | 评论内容                           |
| time       | 发表时间                           |
| like_num   | 赞数                               |



#### 发帖

接口地址：/forum/post/new

请求方式：POST

请求参数：

| 名称  | 类型   | 必填 | 说明 |
| ----- | ------ | ---- | ---- |
| title | string | 是   |      |
| type  | int | 是   |      |
| text  | string | 是   |      |

返回参数：

| HTTP状态码 | 返回json中，msg的值        | 说明 |
| ---------- | -------------------------- | ---- |
| 200        | 操作成功                   |      |
| 403        | 未登录或登录超时\|参数无效 |      |



#### 修改帖子
接口地址：/forum/post/$pid/edit

请求方式：POST

请求参数：

| 名称  | 类型   | 必填 | 说明    |
| ----- | ------ | ---- | ------- |
| pid   | int    | 是   | 在URL中 |
| title | string | 是   |         |
| text  | string | 是   |         |

返回参数：

| HTTP状态码 | 返回json中，msg的值                              | 说明 |
| ---------- | ------------------------------------------------ | ---- |
| 200        | 操作成功                                         |      |
| 403        | 未登录或登录超时\|参数无效\|只有作者可以修改文章 |      |



#### 删帖
接口地址：/forum/post/$pid/delete

请求方式：GET / POST

请求参数：

| 名称 | 类型 | 必填 | 说明    |
| ---- | ---- | ---- | ------- |
| pid  | int  | 是   | 在URL中 |

返回参数：

| HTTP状态码 | 返回json中，msg的值          | 说明     |
| ---------- | ---------------------------- | -------- |
| 200        | 操作成功                     |          |
| 403        | 未登录或登录超时\|找不到文章 | 含无权限 |



#### 给帖子点赞

接口地址：/forum/post/$pid/like

请求方式：GET / POST

请求参数：

| 名称 | 类型 | 必填 | 说明    |
| ---- | ---- | ---- | ------- |
| pid  | int  | 是   | 在URL中 |

返回参数：

| HTTP状态码 | 返回json中，msg的值                         | 说明 |
| ---------- | ------------------------------------------- | ---- |
| 200        | 操作成功                                    |      |
| 403        | 未登录或登录超时\|找不到文章\|已经点过赞啦~ |      |



#### 评论文章
接口地址：/forum/comment/new

请求方式：POST

请求参数：

| 名称 | 类型   | 必填 | 说明     |
| ---- | ------ | ---- | -------- |
| pid  | int    | 是   | 文章ID   |
| text | string | 是   | 评论内容 |

返回参数：

| HTTP状态码 | 返回json中，msg的值                    | 说明 |
| ---------- | -------------------------------------- | ---- |
| 200        | 操作成功                               |      |
| 403        | 未登录或登录超时\|参数无效\|找不到文章 |      |



#### 删评
接口地址：/forum/comment/$cid/delete

请求方式：GET / POST

请求参数：

| 名称 | 类型 | 必填 | 说明    |
| ---- | ---- | ---- | ------- |
| cid  | int  | 是   | 在URL中 |

返回参数：

| HTTP状态码 | 返回json中，msg的值          | 说明     |
| ---------- | ---------------------------- | -------- |
| 200        | 操作成功                     |          |
| 403        | 未登录或登录超时\|找不到评论 | 含无权限 |



#### 给评论点赞

接口地址：/forum/comment/$cid/like

请求方式：GET / POST

请求参数：

| 名称 | 类型 | 必填 | 说明    |
| ---- | ---- | ---- | ------- |
| cid  | int  | 是   | 在URL中 |

返回参数：

| HTTP状态码 | 返回json中，msg的值                         | 说明 |
| ---------- | ------------------------------------------- | ---- |
| 200        | 操作成功                                    |      |
| 403        | 未登录或登录超时\|找不到评论\|已经点过赞啦~ |      |



### 影集生成接口

#### 新建影集

接口地址：/movie/new

请求方式：GET 

接口说明：调用接口后，在服务器 "./media/movies/"+work_id处新增一文件夹

返回参数：

| 状态码 | 返回json中，msg的值 | 说明               |
| ------ | ------------------- | ------------------ |
| 200    | 操作成功            | 作业集将会定期清理 |
| 403    | 未登录或登录超时    |                    |

返回JSON说明：


| 名称    | 说明     |
| ------- | -------- |
| work_id | 作业集号 |



#### 上传文件

接口地址：/movie/$work_id/upload

请求方式： POST

接口说明：文件名将在服务器按时间重新生成

请求参数：

| 名称 | 类型 | 必填 | 说明 |
| ---- | ---- | ---- | ---- |
| file | file | 是   | 文件 |

返回参数：

| 状态码 | 返回json中，msg的值                          | 说明 |
| ------ | -------------------------------------------- | ---- |
| 200    | 操作成功                                     |      |
| 403    | 未登录或登录超时\|找不到作业集\|未获取到file |      |

返回JSON说明：


| 名称     | 说明                                                      |
| -------- | --------------------------------------------------------- |
| filename | 上传后的文件名                                            |
| url      | 相对于根目录地址，"/media/movies/"+$work_id+"/"+$filename |

info.json:

```json
{"factors":[{"types":["space bar","notebook","iPod"],"values":[0.003921569,0.06666667,0.9137255]},{"types":["schipperke","Chihuahua","Cardigan"],"values":[0.0627451,0.12156863,0.45882353]},{"types":["Pomeranian","dhole","lesser panda"],"values":[0.047058824,0.09411765,0.58431375]},{"types":["seashore","sandbar","lakeside"],"values":[0.07450981,0.101960786,0.5294118]}],"images":["IMG_20210328_102940.jpg","IMG_20210325_181250.jpg","IMG_20210320_130829.jpg","IMG_20210328_173510.jpg"],"title":"标题","description":"描述"}
```



#### 开始生成影集

接口地址：/movie/$work_id/start

请求方式：GET

说明：调用该接口后，后端启动异步任务。根据不同任务状态，决定是否重新生成。

返回参数：

| 状态码 | 返回json中，msg的值                                          | 说明 |
| ------ | ------------------------------------------------------------ | ---- |
| 200    | 操作成功\|已重新加入队列\|原执行失败，已重新加入队列\|已加入队列 |      |
| 403    | 未登录或登录超时\|找不到作业集\|影集已过期，请重新新建\|任务已完成\|已在 "+task_obj.state+" 队列中 |      |

具体情形：

首先检查文件夹是否存在，不存在，设为 -2（已过期）

| 数据库中保存的status | 数据库中保存的work_id是否有效 | 操作                            |
| -------------------- | ----------------------------- | ------------------------------- |
| 0（未开始）          | -                             | 加入到影集生成队列              |
| 1，2（排队/正处理）  | 是/否                         | 拒绝处理/重新加入到影集生成队列 |
| 3（完成）            | -                             | 拒绝处理                        |



#### 获取作业状态

接口地址：/movie/$work_id/status

请求方式：GET

说明：调用该接口后，后端启动异步任务，需要手动查询处理状态

返回参数：

| 状态码 | 返回json中，msg的值            | 说明 |
| ------ | ------------------------------ | ---- |
| 200    | 操作成功                       |      |
| 403    | 未登录或登录超时\|找不到作业集 |      |

返回JSON说明：


| 名称        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| work_id     | 作业ID                                                       |
| uid         |                                                              |
| create_time | 作业创建时间                                                 |
| update_time | 作业更新时间                                                 |
| status      | 作业状态，(0,'未开始'),(1,"排队等待中"),(2,"正在生成"),(3,"已生成"),(-1,"生成失败"),(-2,"已过期被清理") |
| description | 等待用户提供信息\|排队等待中\|正在处理\|处理完成\|生成失败\|找不到任务，请重新启动\|已过期 |
| info        | Celery 任务 ID（完成前） 或 生成的影集链接（/media/movie/$work_id/result.mp4，生成完成后） |
| image_num   | 在服务器上暂存的图片数目                                     |
| image_urls  | 数组，图片的绝对地址                                         |

```json
{
    "code": 200,
    "msg": "获取成功",
    "data": {
        "work_id": 1,
        "uid": 10018,
        "create_time": "2021-03-09 00:14:29",
        "update_time": "2021-03-09 00:37:06",
        "status": 3,
        "description": "处理完成",
        "info": null,
        "image_num": 2,
        "image_urls": [
            "/media/movies/1/1615221875058025.png",
            "/media/movies/1/1615220094945325.jpg"
        ]
    }
}
```



#### 删除影集

接口地址：/movie/$work_id/delete

请求方式：GET

说明：删除影集文件夹

返回参数：

| 状态码 | 返回json中，msg的值            | 说明 |
| ------ | ------------------------------ | ---- |
| 200    | 操作成功                       |      |
| 403    | 未登录或登录超时\|找不到作业集 |      |



####  用户影集列表

接口地址：/movie/list

请求方式：GET

注：返回非失败影集（status>=0）

返回参数：

| 状态码 | 返回json中，msg的值 | 说明 |
| ------ | ------------------- | ---- |
| 200    | 操作成功            |      |
| 403    | 未登录或登录超时    |      |

返回JSON说明：

| 名称       | 说明 |
| ---------- | ---- |
| uid        |      |
| movie_num  |      |
| **movies** | 数组 |

movies数组中，每一项：


| 名称              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| work_id           |                                                              |
| movie_title       | 影集标题                                                     |
| movie_description | 影集描述                                                     |
| create_time       | 作业创建时间                                                 |
| update_time       | 作业更新时间                                                 |
| status            | 作业状态，(0,'未开始'),(-1,"生成失败"),(-2,"已过期被清理")<br/>100 排队等待中 101 正在分析命令参数 102 正在分析图片 103 正在生成诗词 104 正在匹配模板 105 正在生成影集 200 处理完成 |
| status_msg        | 等待用户提供信息\|排队等待中\|处理完成\|生成失败\|找不到任务，请重新启动\|已过期\|排队等待中 正在分析命令参数 正在分析图片 正在生成诗词  正在匹配模板 正在生成影集 |
| result_msg        | Celery 任务 ID（完成前） 或 生成的影集链接（生成完成后）     |
| tag               | 分类标签                                                     |
| like_num          | 赞数                                                         |
| comment_num       | 评论数                                                       |

```json
{
    "code": 200,
    "msg": "获取成功",
    "data": {
        "uid": 1,
        "movie_num": 4,
        "movies": [
            {
                "work_id": 1,
                "create_time": "2021-03-08 21:00:29",
                "update_time": "2021-03-09 20:12:59",
                "status": -2,
                "description": "已过期",
                "info": null
            },
            {
                "work_id": 2,
                "create_time": "2021-03-09 12:45:29",
                "update_time": "2021-03-09 14:51:54",
                "status": 3,
                "description": "处理完成",
                "info": "1c6a1705-21a2-4f72-8551-7da0716eaf31"
            }
        ]
    }
}
```



####  用户所有影集列表

接口地址：/movie/myall

请求方式：GET



####  分享的影集列表

接口地址：/movie/all

请求方式：GET

注：返回公开分享的影集

返回JSON说明：

| 名称       | 说明 |
| ---------- | ---- |
| movie_num  |      |
| **movies** | 数组 |

movies数组中，每一项：


| 名称              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| work_id           |                                                              |
| uid               |                                                              |
| uname             |                                                              |
| avatar            |                                                              |
| movie_title       | 影集标题                                                     |
| movie_description | 影集描述                                                     |
| movie_cover       |                                                              |
| create_time       | 作业创建时间                                                 |
| update_time       | 作业更新时间                                                 |
| status            | 作业状态，(0,'未开始'),(-1,"生成失败"),(-2,"已过期被清理")<br/>100 排队等待中 101 正在分析命令参数 102 正在分析图片 103 正在生成诗词 104 正在匹配模板 105 正在生成影集 200 处理完成 |
| status_msg        | 等待用户提供信息\|排队等待中\|处理完成\|生成失败\|找不到任务，请重新启动\|已过期\|排队等待中 正在分析命令参数 正在分析图片 正在生成诗词  正在匹配模板 正在生成影集 |
| result_msg        | Celery 任务 ID（完成前） 或 生成的影集链接（生成完成后）     |
| tag               | 分类标签                                                     |
| like_num          | 赞数                                                         |
| comment_num       | 评论数                                                       |

```json
{
    "code": 200,
    "msg": "获取成功",
    "data": {
        "uid": 1,
        "movie_num": 4,
        "movies": [
            {
                "work_id": 1,
                "create_time": "2021-03-08 21:00:29",
                "update_time": "2021-03-09 20:12:59",
                "status": -2,
                "description": "已过期",
                "info": null
            },
            {
                "work_id": 2,
                "create_time": "2021-03-09 12:45:29",
                "update_time": "2021-03-09 14:51:54",
                "status": 3,
                "description": "处理完成",
                "info": "1c6a1705-21a2-4f72-8551-7da0716eaf31"
            }
        ]
    }
}
```



### 长图生成接口

#### 新建长图

接口地址：/photo/new

请求方式：GET 

接口说明：调用接口后，在服务器 "./media/photos/"+work_id处新增一文件夹

返回参数：

| 状态码 | 返回json中，msg的值 | 说明               |
| ------ | ------------------- | ------------------ |
| 200    | 操作成功            | 作业集将会定期清理 |
| 403    | 未登录或登录超时    |                    |

返回JSON说明：


| 名称    | 说明     |
| ------- | -------- |
| work_id | 作业集号 |



#### 上传文件

接口地址：/photo/$work_id/upload

请求方式： POST

接口说明：文件名将在服务器按时间重新生成

请求参数：

| 名称 | 类型 | 必填 | 说明 |
| ---- | ---- | ---- | ---- |
| file | file | 是   | 文件 |

返回参数：

| 状态码 | 返回json中，msg的值                          | 说明 |
| ------ | -------------------------------------------- | ---- |
| 200    | 操作成功                                     |      |
| 403    | 未登录或登录超时\|找不到作业集\|未获取到file |      |

返回JSON说明：


| 名称     | 说明                                                      |
| -------- | --------------------------------------------------------- |
| filename | 上传后的文件名                                            |
| url      | 相对于根目录地址，"/media/photos/"+$work_id+"/"+$filename |



#### 开始生成长图

接口地址：/photo/$work_id/start

请求方式：GET

说明：调用该接口后，后端启动异步任务。根据不同任务状态，决定是否重新生成。

返回参数：

| 状态码 | 返回json中，msg的值                                          | 说明 |
| ------ | ------------------------------------------------------------ | ---- |
| 200    | 操作成功\|已重新加入队列\|原执行失败，已重新加入队列\|已加入队列 |      |
| 403    | 未登录或登录超时\|找不到作业集\|任务已过期，请重新新建\|任务已完成\|已在 "+task_obj.state+" 队列中 |      |



#### 获取作业状态

接口地址：/photo/$work_id/status

请求方式：GET

说明：调用该接口后，后端启动异步任务，需要手动查询处理状态

返回参数：

| 状态码 | 返回json中，msg的值            | 说明 |
| ------ | ------------------------------ | ---- |
| 200    | 操作成功                       |      |
| 403    | 未登录或登录超时\|找不到作业集 |      |

返回JSON说明：


| 名称              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| work_id           | 作业ID                                                       |
| uid               | 用户ID                                                       |
| photo_title       | 标题                                                         |
| photo_description | 描述                                                         |
| photo_cover       | 封面url                                                      |
| cover_width       | 封面宽                                                       |
| cover_height      | 封面高                                                       |
| photo_width       | 长图宽                                                       |
| photo_height      | 长图高                                                       |
| create_time       | 作业创建时间                                                 |
| update_time       | 作业更新时间                                                 |
| status            | 作业状态，(0,'未开始'),(1,"排队等待中"),(2,"正在生成"),(3,"已生成"),(-1,"生成失败"),(-2,"已过期被清理") |
| result_msg        | 等待用户提供信息\|排队等待中\|正在处理\|处理完成\|生成失败\|找不到任务，请重新启动\|已过期 |
| info              | Celery 任务 ID（完成前） 或 生成的长图链接（生成完成后）     |
| image_num         | 在服务器上暂存的图片数目                                     |
| image_urls        | 数组，图片的绝对地址                                         |



#### 删除长图

接口地址：/photo/$work_id/delete

请求方式：GET

说明：删除影集文件夹

返回参数：

| 状态码 | 返回json中，msg的值            | 说明 |
| ------ | ------------------------------ | ---- |
| 200    | 操作成功                       |      |
| 403    | 未登录或登录超时\|找不到作业集 |      |



####  用户生成长图列表

接口地址：/photo/list

请求方式：GET

注：返回非失败影集（status>=0）

返回参数：

| 状态码 | 返回json中，msg的值 | 说明 |
| ------ | ------------------- | ---- |
| 200    | 操作成功            |      |
| 403    | 未登录或登录超时    |      |

返回JSON说明：


| 名称              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| work_id           |                                                              |
| photo_title       | 影集标题                                                     |
| photo_description | 影集描述                                                     |
| photo_cover       | 封面路径                                                     |
| cover_width       | 封面宽                                                       |
| cover_height      | 封面高                                                       |
| photo_width       | 长图宽                                                       |
| photo_height      | 长图高                                                       |
| create_time       | 作业创建时间                                                 |
| update_time       | 作业更新时间                                                 |
| status            | 作业状态，(0,'未开始'),(-1,"生成失败"),(-2,"已过期被清理")<br/>100 排队等待中 101 正在分析命令参数 102 正在分析图片 103 正在生成诗词 104 正在匹配模板 105 正在生成影集 200 处理完成 |
| status_msg        | 等待用户提供信息\|排队等待中\|处理完成\|生成失败\|找不到任务，请重新启动\|已过期\|排队等待中 正在分析命令参数 正在分析图片 正在生成诗词  正在匹配模板 正在生成影集 |
| result_msg        | Celery 任务 ID（完成前） 或 生成的影集链接（生成完成后）     |
| like_num          | 赞数                                                         |
| comment_num       | 评论数                                                       |



####  用户所有长图列表

接口地址：/photo/myall

请求方式：GET



####  分享的长图列表

接口地址：/photo/all

请求方式：GET

注：返回非失败影集（status>=0）

返回参数：

| 状态码 | 返回json中，msg的值 | 说明 |
| ------ | ------------------- | ---- |
| 200    | 操作成功            |      |
| 403    | 未登录或登录超时    |      |

返回JSON说明：


| 名称              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| work_id           | 长图id                                                       |
| uid               | 用户ID                                                       |
| uname             | 用户名                                                       |
| avatar            | 头像url                                                      |
| photo_title       | 影集标题                                                     |
| photo_description | 影集描述                                                     |
| photo_cover       | 封面路径                                                     |
| cover_width       | 封面宽                                                       |
| cover_height      | 封面高                                                       |
| photo_width       | 长图宽                                                       |
| photo_height      | 长图高                                                       |
| create_time       | 作业创建时间                                                 |
| update_time       | 作业更新时间                                                 |
| status            | 作业状态，(0,'未开始'),(-1,"生成失败"),(-2,"已过期被清理")<br/>100 排队等待中 101 正在分析命令参数 102 正在分析图片 103 正在生成诗词 104 正在匹配模板 105 正在生成影集 200 处理完成 |
| status_msg        | 等待用户提供信息\|排队等待中\|处理完成\|生成失败\|找不到任务，请重新启动\|已过期\|排队等待中 正在分析命令参数 正在分析图片 正在生成诗词  正在匹配模板 正在生成影集 |
| result_msg        | Celery 任务 ID（完成前） 或 生成的影集链接（生成完成后）     |
| like_num          | 赞数                                                         |
| comment_num       | 评论数                                                       |



### 影集分享

####  分享的影集分类

接口地址：/movie/tag/\<int:tag\>

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明 |
| ---- | ---- | ---- | ---- |
| tag  | int  | 是   | 标签 |



#### 点赞影集

接口地址：/movie/\<int:wid\>/like

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明   |
| ---- | ---- | ---- | ------ |
| wid  | int  | 是   | 影集ID |

返回参数：

| HTTP状态码 | 返回json中，msg的值                         | 说明 |
| ---------- | ------------------------------------------- | ---- |
| 200        | 操作成功                                    |      |
| 403        | 未登录或登录超时\|找不到影集\|已经点过赞啦~ |      |



#### 获取影集评论

接口地址：/movie/\<int:wid\>/comment

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明   |
| ---- | ---- | ---- | ------ |
| wid  | int  | 是   | 影集ID |

返回JSON说明：


| 名称        | 说明                     |
| ----------- | ------------------------ |
| comment_num | 评论总数                 |
| comments    | 评论列表，格式如下表所示 |

| 名称       | 说明                               |
| ---------- | ---------------------------------- |
| comment_id | 评论ID                             |
| uid        | 用户ID                             |
| uname      | 用户名                             |
| gender     | 性别                               |
| avatar     | 用户头像文件相对于站点根目录的地址 |
| text       | 评论内容                           |
| time       | 发表时间                           |
| like_num   | 赞数                               |



#### 评论影集

接口地址：/movie/\<int:wid\>/comment/new

请求方式：POST

请求参数：

| 名称 | 类型   | 必填 | 说明     |
| ---- | ------ | ---- | -------- |
| wid  | int    | 是   | 影集ID   |
| text | string | 是   | 评论内容 |

返回参数：

| HTTP状态码 | 返回json中，msg的值        | 说明 |
| ---------- | -------------------------- | ---- |
| 200        | 操作成功                   |      |
| 403        | 未登录或登录超时\|参数无效 |      |



#### 给评论点赞

接口地址：/movie/comment/\<int:cid\>/like

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明       |
| ---- | ---- | ---- | ---------- |
| cid  | int  | 是   | 影集评论ID |

返回参数：

| HTTP状态码 | 返回json中，msg的值                         | 说明 |
| ---------- | ------------------------------------------- | ---- |
| 200        | 操作成功                                    |      |
| 403        | 未登录或登录超时\|找不到评论\|已经点过赞啦~ |      |



#### 删评

接口地址：/movie/comment/\<int:cid\>/delete

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明       |
| ---- | ---- | ---- | ---------- |
| cid  | int  | 是   | 影集评论ID |

返回参数：

| HTTP状态码 | 返回json中，msg的值          | 说明               |
| ---------- | ---------------------------- | ------------------ |
| 200        | 操作成功                     |                    |
| 403        | 未登录或登录超时\|找不到评论 | 非评论发布者无权限 |



### 长图分享

#### 点赞长图

接口地址：/photo/\<int:wid\>/like

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明   |
| ---- | ---- | ---- | ------ |
| wid  | int  | 是   | 长图ID |

返回参数：

| HTTP状态码 | 返回json中，msg的值                         | 说明 |
| ---------- | ------------------------------------------- | ---- |
| 200        | 操作成功                                    |      |
| 403        | 未登录或登录超时\|找不到长图\|已经点过赞啦~ |      |



#### 获取长图评论

接口地址：/photo/\<int:wid\>/comment

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明   |
| ---- | ---- | ---- | ------ |
| wid  | int  | 是   | 长图ID |

返回JSON说明：


| 名称        | 说明                     |
| ----------- | ------------------------ |
| comment_num | 评论总数                 |
| comments    | 评论列表，格式如下表所示 |

| 名称       | 说明                               |
| ---------- | ---------------------------------- |
| comment_id | 评论ID                             |
| uid        | 用户ID                             |
| uname      | 用户名                             |
| gender     | 性别                               |
| avatar     | 用户头像文件相对于站点根目录的地址 |
| text       | 评论内容                           |
| time       | 发表时间                           |
| like_num   | 赞数                               |



#### 评论长图

接口地址：/photo/\<int:wid\>/comment/new

请求方式：POST

请求参数：

| 名称 | 类型   | 必填 | 说明     |
| ---- | ------ | ---- | -------- |
| wid  | int    | 是   | 长图ID   |
| text | string | 是   | 评论内容 |

返回参数：

| HTTP状态码 | 返回json中，msg的值        | 说明 |
| ---------- | -------------------------- | ---- |
| 200        | 操作成功                   |      |
| 403        | 未登录或登录超时\|参数无效 |      |



#### 给评论点赞

接口地址：/photo/comment/\<int:cid\>/like

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明       |
| ---- | ---- | ---- | ---------- |
| cid  | int  | 是   | 长图评论ID |

返回参数：

| HTTP状态码 | 返回json中，msg的值                         | 说明 |
| ---------- | ------------------------------------------- | ---- |
| 200        | 操作成功                                    |      |
| 403        | 未登录或登录超时\|找不到评论\|已经点过赞啦~ |      |



#### 删评

接口地址：/photo/comment/\<int:cid\>/delete

请求方式：GET

请求参数：

| 名称 | 类型 | 必填 | 说明       |
| ---- | ---- | ---- | ---------- |
| cid  | int  | 是   | 长图评论ID |

返回参数：

| HTTP状态码 | 返回json中，msg的值          | 说明               |
| ---------- | ---------------------------- | ------------------ |
| 200        | 操作成功                     |                    |
| 403        | 未登录或登录超时\|找不到评论 | 非评论发布者无权限 |



 ### 模型测试接口

#### 色彩提取

接口地址：/api/color

请求方式：POST

请求参数：

| 名称  | 类型 | 必填 | 说明       |
| ----- | ---- | ---- | ---------- |
| image | file | 是   | 待处理图片 |
| k     | int  | 否   | 默认为3    |

返回参数：

| HTTP状态码 | 返回json中，msg的值 | 说明 |
| ---------- | ------------------- | ---- |
| 200        |                     |      |
| 403        | 未获取到image       |      |

```json
{
    "code": 200,
    "msg": "获取成功",
    "data": [
        [
            32.281213191990574,
            92.47355712603063,
            87.32547114252061
        ],
        [
            245.56026363473447,
            185.5199219450031,
            172.16564783656239
        ],
        [
            220.0655982521882,
            102.63987333895656,
            64.77920048673239
        ]
    ]
}
```



#### 天气识别

接口地址：/api/weather

请求方式：POST

请求参数：

| 名称  | 类型 | 必填 | 说明       |
| ----- | ---- | ---- | ---------- |
| image | file | 是   | 待处理图片 |

返回参数：

| HTTP状态码 | 返回json中，msg的值 | 说明 |
| ---------- | ------------------- | ---- |
| 200        |                     |      |
| 403        | 未获取到image       |      |

```json
{
    "code": 200,
    "msg": "获取成功",
    "data": {
        "weather": "sunny",
        "weather_id": 3,
        "tags": [
            "cloudy",
            "rainy",
            "snow",
            "sunny"
        ],
        "rate": [
            -3.381439208984375,
            -0.9108459949493408,
            0.3688693344593048,
            3.5914697647094727
        ]
    }
}
```



#### 风格迁移

接口地址：/api/style

请求方式：POST

请求参数：

| 名称  | 类型 | 必填 | 说明       |
| ----- | ---- | ---- | ---------- |
| image | file | 是   | 待处理图片 |

返回参数：

| HTTP状态码 | 返回json中，msg的值             | 说明 |
| ---------- | ------------------------------- | ---- |
| 200        | base64编码的jpg格式图像         |      |
| 403        | 未获取到image\|指定的风格不存在 |      |



#### 超分辨率

接口地址：/api/fsrcnn

请求方式：POST

请求参数：

| 名称  | 类型 | 必填 | 说明                     |
| ----- | ---- | ---- | ------------------------ |
| image | file | 是   | 待处理图片               |
| scale | int  | 否   | 缩放倍数，2,3,4，默认为3 |

返回参数：

| HTTP状态码 | 返回json中，msg的值         | 说明 |
| ---------- | --------------------------- | ---- |
| 200        | base64编码的jpg格式图像     |      |
| 403        | 未获取到image\|缩放倍数错误 |      |

#### 诗词生成

接口地址：/api/poem

请求方式：POST

请求参数：

| 名称       | 类型   | 必填 | 说明                                                         |
| ---------- | ------ | ---- | ------------------------------------------------------------ |
| keyword    | string | 是   | 关键词                                                       |
| length     | int    | 否   | 选择诗词长度，5 或 7，默认 5                                 |
| experience | int    | 否   | 选择生活经历，0: 戎马生涯, 1: 乡村生活, 2: 其他:, -1: 不指定，默认为 1 |
| history    | int    | 否   | 选择历史背景，0: 盛世, 1: 乱世, -1: 不指定，默认为 0         |

返回参数：

| HTTP状态码 | 返回json中，msg的值     | 说明 |
| ---------- | ----------------------- | ---- |
| 200        | GET操作返回HTML测试表单 |      |
| 403        |                         |      |

```json
{"code": 200, "msg": "获取成功", "data": ["缥缈萦回合\n丛台废苑湾\n此身开济域\n风度野人闲", "兰若香台接\n松楸拱帝秦\n丝纶朝野性\n云树隐闲人"]}
```



#### 图片生成诗词

接口地址：/api/img2poem

请求方式：POST

请求参数：

| 名称       | 类型   | 必填 | 说明                                                         |
| ---------- | ------ | ---- | ------------------------------------------------------------ |
| keyword    | string | 是   | 关键词                                                       |
| types      | string | 是   | 逗号分隔的物体识别结果                                       |
| values     | float  | 是   | 逗号分隔的概率                                               |
| length     | int    | 否   | 选择诗词长度，5 或 7，默认 5                                 |
| experience | int    | 否   | 选择生活经历，0: 戎马生涯, 1: 乡村生活, 2: 其他:, -1: 不指定，默认为 1 |
| history    | int    | 否   | 选择历史背景，0: 盛世, 1: 乱世, -1: 不指定，默认为 0         |

返回参数：

| HTTP状态码 | 返回json中，msg的值     | 说明 |
| ---------- | ----------------------- | ---- |
| 200        | GET操作返回HTML测试表单 |      |
| 403        |                         |      |

```json
{
    "code": 200,
    "msg": "获取成功",
    "data": {
        "poem": "肩舆出岫乘闲去\n麋鹿归人走马还\n野寺有时僧到处\n柴门无路夕阳关",
        "keywords": "晴 桶 房屋"
    }
}
```



#### 坐标解析

接口地址：/api/location

请求方式：GET

请求参数：

| 名称      | 类型  | 必填 | 说明 |
| --------- | ----- | ---- | ---- |
| longitude | float | 是   | 经度 |
| latitude  | float | 是   | 纬度 |

返回参数：

| HTTP状态码 | 返回json中，msg的值           | 说明                     |
| ---------- | ----------------------------- | ------------------------ |
| 200        | province\|city\|county\|image | 省\|市\|区县\|城市印象图 |
| 403        |                               |                          |

```json
{"code": 200, "msg": "获取成功", "data": {"province": "A省", "city": "B市", "county": "C区", "image": "/static/city/def1.png"}}
```



## 管理接口及信息

#### 管理后台

说明：管理分享社区、用户账号等数据

地址：/admin/

认证：web认证，样例用户名 travel  密码 travel123

#### 日志接口

说明：方便运维快捷查看系统运行状况

地址：/media/log.txt /media/celery.txt

认证：在Web服务器配置的 HTTP基本认证



## 服务器信息

django后端 https://travel.mrning.com/ 主站1 39.107.235.253 备站1 81.71.91.25

django后端CDN https://travel-cdn.mrning.com/



文件服务器1 https://gz.file.mrning.com/ 

文件服务器2 https://ca.file.mrning.com/ 



 